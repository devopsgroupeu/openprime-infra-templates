{{- $projectStep := 100 -}} {{/* large enough so waves don't collide across apps in a project */}}

{{- range $pIdx, $appProject := .Values.appProjects }}
  {{- $projectBase := mul $pIdx $projectStep }}
  {{- range $aIdx, $application := $appProject.applications }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $application.name }}
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: {{ add $projectBase $aIdx | printf "%v" | quote }}
spec:
  project: default # TODO: handle multiple projects correctly
  sources:
  - targetRevision: {{ $application.targetRevision | default "main" }}
    repoURL: {{ $application.repoURL | default $.Values.globals.repoURL | quote }}
    {{- if $application.path }}
    {{- if $application.directoryRecurse }}
    directory:
      recurse: true
    {{- end }}
    path: "templates/argocd/charts/{{ $application.path }}"
    {{- end }}
    {{- if $application.chart }}
    chart: {{ $application.chart }}
    {{- end }}
    helm:
      {{- if $application.skipCrds }}
      skipCrds: true
      {{- end }}
      {{- if not $application.skipValuesFile }}
      valueFiles:
      - $values/templates/argocd/values/{{ $application.name }}.yaml
      {{- end }}
  - repoURL: {{ $.Values.globals.repoURL | quote }}
    targetRevision: {{ $application.targetRevision | default "main" }}
    ref: values
  destination:
    namespace: {{ $appProject.namespace }}
    name: in-cluster
  syncPolicy:
    {{- if $application.autoSync }}
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
    syncOptions:
    - CreateNamespace=true
    - PruneLast=true
    - ApplyOutOfSyncOnly=true
    - RespectIgnoreDifferences=true
    {{- if $application.replace }}
    - Replace=true
    {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
